image: alpine/edge
packages:
  - go
sources:
  - https://git.sr.ht/~whereswaldon/wisteria
environment:
  github_mirror_url: "git@github.com:arborchat/wisteria.git"
secrets:
  - c18470ea-9f49-4fcf-8814-2223cfa175f1
  - 3f11ff14-dff1-45ca-990c-c69873656f63
tasks:
  - test: |
      cd wisteria
      go test -cover
  - cross_compile: |
      wget 'https://github.com/goreleaser/goreleaser/releases/download/v0.126.0/goreleaser_Linux_x86_64.tar.gz'
      tar xvzf goreleaser_Linux_x86_64.tar.gz goreleaser
      mv -v goreleaser ~/go/bin/
      cd wisteria
      ~/go/bin/goreleaser --snapshot --skip-publish --rm-dist
      cat dist/checksums.txt
  - annotate: |
      go get git.sr.ht/~sircmpwn/annotatego
      cd wisteria
      ~/go/bin/annotatego -v -T git.sr.ht/~whereswaldon/wisteria... > annotations.json
      ../upload-annotations annotations.json whereswaldon wisteria
  - mirror_to_github: |
      cd wisteria
      ./.builds/mirror.sh "$github_mirror_url"
